% Annotate LaTeX Equations
% 
% (c) ST John, https://github.com/st--/
%
% 
\NeedsTeXFormat{LaTeX2e}[1994/06/01]
\ProvidesPackage{annotate_equations}
  [2022/02/09 v0.01 LaTeX package for easily annotating equations]

\RequirePackage{tikz}
\RequirePackage{xcolor}

\usetikzlibrary{backgrounds}
\usetikzlibrary{arrows,shapes}
\usetikzlibrary{tikzmark} % for \tikzmarknode
\usetikzlibrary{calc} % for computing the midpoint between two nodes, e.g. at ($(p1.north)!0.5!(p2.north)$) 

\newcommand{\eqnhighlightheight}{}  % colorbox will shrink to content
\renewcommand{\eqnhighlightheight}{\mathstrut} % colorbox will always have full height

\newcommand{\eqnhighlightshade}{17}  % light
%\renewcommand{\eqnhighlightshade}{47}  % dark

\newcommand{\eqnannotationtext}[1]{\textsf{\footnotesize\strut #1}}

\newcommand{\eqnhighlightbox}[2]{%
% \colorbox sets the second argument in text mode, so for use within equations we wrap it in $ $ again
    \mathchoice% to get right font size in each mode:
        {\colorbox{#1}{$\displaystyle #2$}}%
        {\colorbox{#1}{$\textstyle #2$}}%
        {\colorbox{#1}{$\scriptstyle #2$}}%
        {\colorbox{#1}{$\scriptscriptstyle #2$}}%
}

\newcommand{\eqnhighlight}[2]{\eqnhighlightbox{#1!\eqnhighlightshade}{\eqnhighlightheight #2}}

\colorlet{defaulthighlight}{black}
\newcommand{\eqnmarkbox}[3][defaulthighlight]{\addvalue{#2}{#1}\tikzmarknode{#2}{\eqnhighlight{#1}{#3}}}
\newcommand{\eqnmark}[3][defaulthighlight]{\addvalue{#2}{#1}\tikzmarknode{#2}{{\color{#1}\eqnhighlightheight#3}}}
%%% TODO: fix height of eqnmark vs eqnmarkbox!

\newcounter{eqnannotatenode}
\newcommand*{\eqnannotateCurrentNode}{eqnannotatenode\theeqnannotatenode}

% from https://tex.stackexchange.com/a/48931/171664 :
\def\addvalue#1#2{\expandafter\gdef\csname eqnannotate@data@#1\endcsname{#2}}
\def\usevalue#1{%
  \ifcsname eqnannotate@data@#1\endcsname
    \csname eqnannotate@data@#1\expandafter\endcsname
  \else
    defaulthighlight%
  \fi
}

\providecommand\EAanchor{north} % default set to "above"
\providecommand\EAwesteast{east} % default set to "right"
% for pgfkeys, see https://tex.stackexchange.com/a/34318/171664
% for no-value keys, see https://tex.stackexchange.com/a/401848/171664
\pgfkeys{
    /eqnannotate/.is family, /eqnannotate,
    above/.code = {\renewcommand\EAanchor{north}},
    below/.code = {\renewcommand\EAanchor{south}},
    left/.code = {\renewcommand\EAwesteast{west}},
    right/.code = {\renewcommand\EAwesteast{east}},
}

%%% TODO: add option for annotation text below arrow

\newcommand{\swapNorthSouth}[1]{%
    \ifnum\pdfstrcmp{#1}{south}=0 north\else south\fi
}
\newcommand{\swapWestEast}[1]{%
    \ifnum\pdfstrcmp{#1}{east}=0 west\else east\fi
}
\newcommand{\EAxshift}[1]{%
    \ifnum\pdfstrcmp{#1}{east}=0 -0.3ex\else 0.3ex\fi
}

% manually adjust \node's yshift until it's at appropriate distance above the equation
% can add xshift as well, if needed (also positive or negative)
\newcommand{\annotatetwo}[5][]{%
    \bgroup% %%% so we don't leak the \def's below
    % #1: (optional) extra args for \node e.g. yshift=...
    \pgfkeys{/eqnannotate, #2}
    \def\myEAanchor{\EAanchor}% %%% anchor for annotation text and line, should be "north" for above and "south" for below
    \def\myEAnodeOne{#3}%
    \def\myEAnodeTwo{#4}%
    \def\myEAtext{#5}%
    \def\myEAcolor{\usevalue{\myEAnodeOne}}%
    \stepcounter{eqnannotatenode}%
    \begin{tikzpicture}[overlay,remember picture,>=stealth,nodes={align=left,inner ysep=1pt},<-]
        % default anchor is at center
        \node[anchor=\swapNorthSouth{\myEAanchor},color=\myEAcolor!85,#1]  % color blended with white to 85%, any (optional) extra args #1
            (\eqnannotateCurrentNode)   % use counter-based "local node"
            at ($(\myEAnodeOne.\myEAanchor)!0.5!(\myEAnodeTwo.\myEAanchor)$)  % centered between the two nodes
            {\eqnannotationtext{\myEAtext}};
        % double arrow to two uses within the equation:
        \draw [<->,color=\myEAcolor] (\myEAnodeOne.\myEAanchor) |- ([yshift=0.1ex] \eqnannotateCurrentNode.south) -| (\myEAnodeTwo.\myEAanchor);  % from node 1 via annotation to node 2, with anchor #6 each
    \end{tikzpicture}%
    \egroup% %%% close group again
}

\newcommand{\annotate}[4][]{%
    \bgroup% %%% so we don't leak the \def's below
    % #1: (optional) extra args for \node e.g. yshift=...
    \pgfkeys{/eqnannotate, #2}
    \def\myEAanchor{\EAanchor}% %%% anchor for annotation text and line, should be "north" for above and "south" for below
    \def\myEAnode{#3}%
    \def\myEAtext{#4}%
    \def\myEAcolor{\usevalue{\myEAnode}}%
    \def\myEAxshift{\EAxshift{\EAwesteast}}%
    \stepcounter{eqnannotatenode}%
    \begin{tikzpicture}[overlay,remember picture,>=stealth,nodes={align=left,inner ysep=1pt},<-]
        \node[anchor=\swapNorthSouth{\myEAanchor} \swapWestEast{\EAwesteast},color=\myEAcolor!85,#1] % TODO for some reason, passing #1 through command doesn't work...
                % anchor=west: align left edge of text on top of tikzmark in equation
                % should be north west for below and south west for above ...
            (\eqnannotateCurrentNode) at (\myEAnode.\myEAanchor)  % \myEAanchor north: above the equation, south: below
            {\eqnannotationtext{\myEAtext}};
        \draw [color=\myEAcolor] (\myEAnode.\myEAanchor)  % arrow from the equation
                % \myEAanchor north: above the equation, south: below
            |- ([xshift=\myEAxshift,yshift=0.1ex] \eqnannotateCurrentNode.south \EAwesteast);
                % - south east: we want line to end at bottom right of annotation text;
                % - negative xshift makes it a little bit shorter;
                % - yshift for aesthetics (\strut is ever so slightly too tall).
    \end{tikzpicture}%
    \egroup% %%% close group again
}

%%% TODO: add option for arrows to multiple nodes

\endinput
%%
%% End of file
